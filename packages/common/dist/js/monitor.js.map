{"version":3,"file":"monitor.js","sources":["../../js/monitor.js"],"sourcesContent":["/**\n * Copyright (c) 2023 - present TinyEngine Authors.\n * Copyright (c) 2023 - present Huawei Cloud Computing Technologies Co., Ltd.\n *\n * Use of this source code is governed by an MIT-style license.\n *\n * THE OPEN SOURCE SOFTWARE IN THIS PRODUCT IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,\n * BUT WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF MERCHANTABILITY OR FITNESS FOR\n * A PARTICULAR PURPOSE. SEE THE APPLICABLE LICENSES FOR MORE DETAILS.\n *\n */\n\nimport { requestEvent } from './http.js'\n\nlet monitorUrl = ''\n\n/**\n * 全局js异常埋点上报\n * @param errorMessage 异常信息\n * @param scriptURI 异常文件路径\n * @param lineNo 异常行号\n * @param columnNo 异常列号\n * @param error 异常堆栈信息\n */\nconst getUrlUnit = () => {\n  const urlUnit = window.location?.search?.substring(1)?.split('&')\n  const unit = {}\n  if (urlUnit.length) {\n    urlUnit.forEach((item) => {\n      let unitItem = item.split('=')\n      unit[unitItem[0]] = unitItem[1]\n    })\n  }\n\n  return JSON.stringify(unit)\n}\n\nconst globalMonitoring = () => {\n  window.onerror = function (errorMessage, scriptURI, lineNo, columnNo, error) {\n    requestEvent(monitorUrl, {\n      event_type: 'design_JSError',\n      url: window.location.href,\n      unit: getUrlUnit(),\n      content: JSON.stringify({ errorMessage: errorMessage, scriptURI: scriptURI, columnNo: columnNo, error: error })\n    })\n  }\n}\n\n/**\n * promise异常埋点上报\n * @param message 异常promise原因\n * @param matchResult 异常promise堆栈\n */\n\nconst promiseMonitoring = () => {\n  window.addEventListener(\n    'unhandledrejection',\n    (event) => {\n      event.preventDefault()\n      let message\n      let matchResult = ''\n      let reason = event.reason\n      if (typeof reason === 'string') {\n        message = reason\n      } else if (typeof reason === 'object') {\n        message = reason.message\n        if (reason.stack) {\n          matchResult = reason.stack.match(/at\\s+(.+):(\\d+):(\\d+)/)\n        }\n      }\n\n      requestEvent(monitorUrl, {\n        event_type: 'design_promiseError',\n        url: window.location.href,\n        unit: getUrlUnit(),\n        content: JSON.stringify({\n          message: message,\n          matchResult: matchResult\n        })\n      })\n    },\n    true\n  )\n}\n\n/**\n * iframe加载完后异常报错埋点上报\n * @param errorMessage 异常信息\n * @param scriptURI 异常文件路径\n * @param lineNo 异常行号\n * @param columnNo 异常列号\n * @param error 异常堆栈信息\n */\n\nexport const iframeMonitoring = () => {\n  if (!monitorUrl) {\n    return false\n  }\n\n  window.frames[0].onerror = function (errorMessage, scriptURI, lineNo, columnNo, error) {\n    requestEvent(monitorUrl, {\n      event_type: 'design_iframeError',\n      url: window.location.href,\n      unit: getUrlUnit(),\n      content: JSON.stringify({\n        errorMessage: errorMessage,\n        scriptURI: scriptURI,\n        columnNo: columnNo,\n        error: error\n      })\n    })\n  }\n}\n\nexport const initMonitor = (url) => {\n  monitorUrl = url\n  globalMonitoring()\n  promiseMonitoring()\n}\n"],"names":["monitorUrl","getUrlUnit","urlUnit","_c","_b","_a","unit","item","unitItem","globalMonitoring","errorMessage","scriptURI","lineNo","columnNo","error","requestEvent","promiseMonitoring","event","message","matchResult","reason","iframeMonitoring","initMonitor","url"],"mappings":";AAcA,IAAIA,IAAa;AAUjB,MAAMC,IAAa,MAAM;;AACvB,QAAMC,KAAUC,KAAAC,KAAAC,IAAA,OAAO,aAAP,gBAAAA,EAAiB,WAAjB,gBAAAD,EAAyB,UAAU,OAAnC,gBAAAD,EAAuC,MAAM,MACvDG,IAAO,CAAA;AACb,SAAIJ,EAAQ,UACVA,EAAQ,QAAQ,CAACK,MAAS;AACxB,QAAIC,IAAWD,EAAK,MAAM,GAAG;AAC7B,IAAAD,EAAKE,EAAS,CAAC,CAAC,IAAIA,EAAS,CAAC;AAAA,EAChC,CAAC,GAGI,KAAK,UAAUF,CAAI;AAC5B,GAEMG,IAAmB,MAAM;AAC7B,SAAO,UAAU,SAAUC,GAAcC,GAAWC,GAAQC,GAAUC,GAAO;AAC3E,IAAAC,EAAaf,GAAY;AAAA,MACvB,YAAY;AAAA,MACZ,KAAK,OAAO,SAAS;AAAA,MACrB,MAAMC,EAAU;AAAA,MAChB,SAAS,KAAK,UAAU,EAAE,cAAcS,GAAc,WAAWC,GAAW,UAAUE,GAAU,OAAOC,EAAK,CAAE;AAAA,IACpH,CAAK;AAAA,EACH;AACF,GAQME,IAAoB,MAAM;AAC9B,SAAO;AAAA,IACL;AAAA,IACA,CAACC,MAAU;AACT,MAAAA,EAAM,eAAc;AACpB,UAAIC,GACAC,IAAc,IACdC,IAASH,EAAM;AACnB,MAAI,OAAOG,KAAW,WACpBF,IAAUE,IACD,OAAOA,KAAW,aAC3BF,IAAUE,EAAO,SACbA,EAAO,UACTD,IAAcC,EAAO,MAAM,MAAM,uBAAuB,KAI5DL,EAAaf,GAAY;AAAA,QACvB,YAAY;AAAA,QACZ,KAAK,OAAO,SAAS;AAAA,QACrB,MAAMC,EAAU;AAAA,QAChB,SAAS,KAAK,UAAU;AAAA,UACtB,SAASiB;AAAA,UACT,aAAaC;AAAA,QACvB,CAAS;AAAA,MACT,CAAO;AAAA,IACH;AAAA,IACA;AAAA,EACJ;AACA,GAWaE,IAAmB,MAAM;AACpC,MAAI,CAACrB;AACH,WAAO;AAGT,SAAO,OAAO,CAAC,EAAE,UAAU,SAAUU,GAAcC,GAAWC,GAAQC,GAAUC,GAAO;AACrF,IAAAC,EAAaf,GAAY;AAAA,MACvB,YAAY;AAAA,MACZ,KAAK,OAAO,SAAS;AAAA,MACrB,MAAMC,EAAU;AAAA,MAChB,SAAS,KAAK,UAAU;AAAA,QACtB,cAAcS;AAAA,QACd,WAAWC;AAAA,QACX,UAAUE;AAAA,QACV,OAAOC;AAAA,MACf,CAAO;AAAA,IACP,CAAK;AAAA,EACH;AACF,GAEaQ,IAAc,CAACC,MAAQ;AAClC,EAAAvB,IAAauB,GACbd,EAAgB,GAChBO,EAAiB;AACnB;"}