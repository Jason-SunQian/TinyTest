{"version":3,"file":"linter.js","sources":["../../js/linter.js"],"sourcesContent":["/**\n * Copyright (c) 2023 - present TinyEngine Authors.\n * Copyright (c) 2023 - present Huawei Cloud Computing Technologies Co., Ltd.\n *\n * Use of this source code is governed by an MIT-style license.\n *\n * THE OPEN SOURCE SOFTWARE IN THIS PRODUCT IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,\n * BUT WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF MERCHANTABILITY OR FITNESS FOR\n * A PARTICULAR PURPOSE. SEE THE APPLICABLE LICENSES FOR MORE DETAILS.\n *\n */\n\nimport eslintWorkerUrl from './worker-files/eslint.worker?worker&url'\n\nexport const initLinter = (editor, monacoInstance, state) => {\n  let workerUrl = new URL(eslintWorkerUrl, import.meta.url)\n\n  // 线上环境，存在 worker 资源跨域的情况\n  if (workerUrl.origin !== location.origin) {\n    const workerBlob = new Blob([`import('${workerUrl}');`], {\n      type: 'application/javascript'\n    })\n    workerUrl = window.URL.createObjectURL(workerBlob)\n  }\n\n  const worker = new Worker(workerUrl, { type: 'module' })\n\n  // 监听 ESLint web worker 的返回\n  worker.onmessage = function (event) {\n    const { markers, version } = event.data\n    const model = editor.getModel()\n\n    state.hasError = markers.filter(({ severity }) => severity === 'Error').length > 0\n\n    // 判断当前 model 的 versionId 与请求时是否一致\n    if (model && model.getVersionId() === version) {\n      monacoInstance.editor.setModelMarkers(model, 'ESLint', markers)\n    }\n  }\n\n  return worker\n}\n\nlet timer = null\n\nexport const lint = (model, worker) => {\n  if (timer) {\n    clearTimeout(timer)\n  }\n\n  // 防抖处理\n  timer = setTimeout(() => {\n    timer = null\n    worker.postMessage({\n      code: model.getValue(),\n      // 发起 ESLint 静态检查时，携带 versionId\n      version: model.getVersionId()\n    })\n  }, 500)\n}\n"],"names":["initLinter","editor","monacoInstance","state","workerUrl","eslintWorkerUrl","workerBlob","worker","event","markers","version","model","severity","timer","lint"],"mappings":"qFAcaA,IAAa,CAACC,GAAQC,GAAgBC,MAAU;AAC3D,MAAIC,IAAY,IAAI,IAAIC,GAAiB,YAAY,GAAG;AAGxD,MAAID,EAAU,WAAW,SAAS,QAAQ;AACxC,UAAME,IAAa,IAAI,KAAK,CAAC,WAAWF,CAAS,KAAK,GAAG;AAAA,MACvD,MAAM;AAAA,IAAA,CACP;AACD,IAAAA,IAAY,OAAO,IAAI,gBAAgBE,CAAU;AAAA,EACnD;AAEA,QAAMC,IAAS,IAAI,OAAOH,GAAW,EAAE,MAAM,UAAU;AAGvD,SAAAG,EAAO,YAAY,SAAUC,GAAO;AAClC,UAAM,EAAE,SAAAC,GAAS,SAAAC,EAAA,IAAYF,EAAM,MAC7BG,IAAQV,EAAO,SAAA;AAErB,IAAAE,EAAM,WAAWM,EAAQ,OAAO,CAAC,EAAE,UAAAG,QAAeA,MAAa,OAAO,EAAE,SAAS,GAG7ED,KAASA,EAAM,aAAA,MAAmBD,KACpCR,EAAe,OAAO,gBAAgBS,GAAO,UAAUF,CAAO;AAAA,EAElE,GAEOF;AACT;AAEA,IAAIM,IAAQ;AAEL,MAAMC,IAAO,CAACH,GAAOJ,MAAW;AACrC,EAAIM,KACF,aAAaA,CAAK,GAIpBA,IAAQ,WAAW,MAAM;AACvB,IAAAA,IAAQ,MACRN,EAAO,YAAY;AAAA,MACjB,MAAMI,EAAM,SAAA;AAAA;AAAA,MAEZ,SAASA,EAAM,aAAA;AAAA,IAAa,CAC7B;AAAA,EACH,GAAG,GAAG;AACR;"}